services:
    api-gateway:
        build:
            context: ./services/api-gateway
            containerfile: Containerfile
        ports:
            - "${API_GATEWAY_PORT:-50051}:${API_GATEWAY_PORT:-50051}"
        env_file:
            - .env
        depends_on:
            redis:
                condition: service_started
            minio:
                condition: service_healthy

    whisper-service:
        build:
            context: ./services/whisper-service
            containerfile: Containerfile
        ports:
            - "${WHISPER_SERVICE_PORT:-50052}:${WHISPER_SERVICE_PORT:-50052}"
        env_file:
            - .env
        depends_on:
            minio:
                condition: service_healthy

    telegram-bot:
        build:
            context: ./services/telegram-bot
            containerfile: Containerfile
        ports:
            - "${TELEGRAM_BOT_PORT:-50053}:${TELEGRAM_BOT_PORT:-50053}"
        env_file:
            - .env
        depends_on:
            minio:
                condition: service_healthy

    redis:
        image: docker.io/library/redis:8.2.2-alpine
        restart: unless-stopped
        ports:
            - "${REDIS_PORT:-6379}:${REDIS_PORT:-6379}"
        volumes:
            - redis-data:/data

    minio:
        image: docker.io/minio/minio:latest
        ports:
            - "${MINIO_PORT:-9000}:${MINIO_PORT:-9000}"
            - "${MINIO_CONSOLE_PORT:-9001}:${MINIO_CONSOLE_PORT:-9001}"
        environment:
            MINIO_ROOT_USER: "${MINIO_ROOT_USER:-minioadmin}"
            MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD:-minioadmin123}"
            MINIO_REGION: "${MINIO_REGION:-us-east-1}"
            MINIO_BROWSER: "on"
        command: server --console-address ":${MINIO_CONSOLE_PORT:-9001}" /data
        volumes:
            - minio-data:/data
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:${MINIO_PORT:-9000}/minio/health/live"]
            interval: 15s
            timeout: 10s
            retries: 5
            start_period: 30s

volumes:
    redis-data:
        driver: local
    minio-data:
        driver: local
